{
  "name": "eod-service",
  "imageType": "IMAGE",
  "parent": "openjdk:11-jre-slim",
  "maintainerEmail": "oleksandr.berezovskyi@ihsmarkit.com",
  "copyPaths": {
    "build/libs/": "/opt/app/",
    "entrypoint.sh": "/opt/app/",
    "credentials.tpl": "/opt/app/"
  },
  "run": [
    "for i in $(ls /opt/app | egrep '.*-(tests|sources|javadoc|contracts).jar$'); do rm -f /opt/app/$i; done",
    "mv `ls /opt/app/*.jar` $(echo `ls /opt/app/*.jar` | sed -En s/-[0-9]+\\.[0-9]+\\.[0-9]+\\(-SNAPSHOT\\)?.jar//p).jar",
    "mkdir /etc/.creds"
  ],
  "entrypoint": "/opt/app/entrypoint.sh",
  "containerConfig": {
    "kind": "ContainerConfig",
    "apiVersion": "v2",
    "deployment": {
      "imageName": "eod-service",
      "imageNamespace": "mcp-tfx-clearing",
      "loadBalanced": true,
      "replicas": 1,
      "routes": [
        {
          "host": "eod.${TFX_DOMAIN}",
          "portNumber": 8443
        }
      ]
    },
    "spec": {
      "serviceAccount": "tfx-clearing-systemuser",
      "volumes": [
        {
          "name": "app-config",
          "configMap": {
            "name": "eod-service-app-config"
          }
        },
        {
          "name": "db-credentials",
          "secret": {
            "secretName": "db-user"
          }
        },
        {
          "name": "amq-credentials",
          "secret": {
            "secretName": "amq-user"
          }
        },
        {
          "name": "logs-storage",
          "persistentVolumeClaim": {
            "claimName": "${KUBERNETES_NAMESPACE}-diagnostics"
          }
        }
      ],
      "container": {
        "args": [],
        "command": [],
        "env": [
          {
            "name": "KUBERNETES_NAMESPACE",
            "valueFrom": {
              "fieldRef": {
                "fieldPath": "metadata.namespace"
              }
            }
          },
          {
            "name": "JAVA_APP_JAR",
            "value": "eod-service.jar"
          },
          {
            "name": "JAVA_OPTS",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "eod-service.java-opts"
              }
            }
          },
          {
            "name": "DB_URL",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "tfx.db.url"
              }
            }
          },
          {
            "name": "DB_SCHEMA",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "tfx.db.schema"
              }
            }
          },
          {
            "name": "AMQ_URL",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "tfx.amq.url"
              }
            }
          },
          {
            "name": "ENV",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "environment.name"
              }
            }
          },
          {
            "name": "SERVER_TIME_ZONE",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "server.timezone"
              }
            }
          },
          {
            "name": "EOD1_JOB_ENABLED",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "eod-service.eod1.job.enabled"
              }
            }
          },
          {
            "name": "CASH_COLLATERAL_BALANCE_UPDATE_JOB_ENABLED",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "eod-service.cash.collateral.balance.job.enabled"
              }
            }
          },
          {
            "name": "AWS_SES_REGION",
            "valueFrom": {
              "configMapKeyRef": {
                "name": "environment-config",
                "key": "aws.ses.region"
              }
            }
          }
        ],
        "readinessProbe": {
          "httpGet": {
            "path": "/actuator/health",
            "port": 8443
          },
          "initialDelaySeconds": 20,
          "timeoutSeconds": 5
        },
        "ports": [
          {
            "containerPort": 8443,
            "name": "http"
          }
        ],
        "resources": {
        },
        "volumeMounts": [
          {
            "name": "db-credentials",
            "readOnly": true,
            "mountPath": "/etc/.db_creds"
          },
          {
            "name": "amq-credentials",
            "readOnly": true,
            "mountPath": "/etc/.amq_creds"
          },
          {
            "name": "app-config",
            "readOnly": true,
            "mountPath": "/opt/app/config"
          },
          {
            "name": "logs-storage",
            "mountPath": "/logs"
          }
        ]
      }
    }
  }
}